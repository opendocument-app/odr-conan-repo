name: build

on: push

jobs:
  build:
    runs-on: ${{ matrix.config.os }}
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: ubuntu-20.04, cc: clang-12, cxx: clang++-12 }
          - { os: ubuntu-20.04, cc: gcc-10, cxx: g++-10 }
          - { os: macos-10.15, cc: clang, cxx: clang++ }
          - { os: windows-2019 }
    steps:
      - name: set up python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: 3.8
      - run: pip install conan

      - name: setup odr conan repo
        run: |
          conan remote remove conancenter
          conan remote add odr-conan-repo https://odr.jfrog.io/artifactory/api/conan/odr-conan
          conan remote add conancenter: https://center.conan.io
          conan config set general.revisions_enabled=1
          conan user -p "${{ secrets.JFROG_PASSWORD }}" -r odr-conan-repo "${{ secrets.JFROG_USERNAME }}"

      - name: cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.conan/data
            C:/Users/runneradmin/.conan/data
          key: ${{ matrix.config.os }}-${{ matrix.config.cxx }}-rev17
          restore-keys: |
            ${{ matrix.config.os }}-${{ matrix.config.cxx }}-

      - name: checkout
        uses: actions/checkout@v3

      - run: conan export recipes/fontforge/conanfile.py
      - run: conan export recipes/libuninameslist/conanfile.py
      - run: conan export recipes/pdf2htmlEX/conanfile.py
      - run: conan export recipes/poppler/conanfile.py
      - run: conan export recipes/spiro/conanfile.py

      - run: conan create --build=missing recipes/pdf2htmlEX/conanfile.py

      - run: conan upload pdf2htmlEX -r odr-conan-repo -c
